<h2 align="center">Подсчет объектов заданного класса(Количество посетителей магазина/кинотеатра/вокзала)</h2>

**Ссылки**:
- [Вконтакте](https://vk.com/id404101172)
- [Telegram](https://t.me/bogdan_shnyra)

## Описание
Назначение алгоритма: Алгоритм предназначен для обнаружения и подсчета количества людей на скриншотах видеофрагментах с использованием компьютерного зрения и машинного обучения. Основное применение – в системах безопасности, мониторинге потоков людей на объектах с масштабным притоком посетителей, таких как вокзалы, аэропорты, магазины, публичные события и т.п.
Задача алгоритма заключается в автоматическом обнаружении людей на переданном изображении, выделении их контуров и подсчете их общего числа. Задача решается с применением предобученной модели глубокого обучения Faster R-CNN с архитектурой ResNet-50 FPN.
Пользователь может подавать на вход алгоритму видеофайлы для обработки. В ходе выполнения алгоритма на экране выводится информация о количестве обнаруженных людей и сохраняются снимки (скриншоты) с отмеченными контурами обнаруженных людей.
Ограничения и условия применения:

- Эффективность и точность алгоритма могут зависеть от качества исходного видеоматериала и освещенности.
- Алгоритм может требовать значительных вычислительных ресурсов, в том числе GPU для ускоренной обработки данных.
- Точность обнаружения может снижаться при наличии перекрывающихся или частично видимых объектов.
Характеристики качества решения:
- Точность обнаружения: зависит от модели и может варьироваться; использование предобученной модели fasterrcnnresnet50fpn позволяет достичь высокой точности при наличии четких изображений.
- Время решения: зависит от длительности обрабатываемого видео, разрешения видеоматериала и мощности оборудования. GPU значительно ускоряет обработку.
Требования к входным и выходным данным:
- Входные данные: видеофайлы. Поддерживается чтение видеофайлов через OpenCV с последующей обработкой каждого кадра.
- Выходные данные: количественное значение обнаруженных людей на каждом обработанном скриншоте и соответствующие изображения с выделенными контурами людей, сохраненные в указанной директории.

Обеспечение информационной совместимости задач в системе достигается за счет использования стандартных форматов видео для входных данных и формата PNG для выходных изображений, а также универсальных библиотеки Python, таких как OpenCV, Torchvision и PIL.
Для выполнения задачи подсчета людей используется алгоритм, основанный на глубоком обучении с применением модели Faster R-CNN с архитектурой ResNet-50 FPN. Эта задача может быть описана с точки зрения методов вычислений и математической модели обнаружения объектов.
Пусть \(X\) - входное изображение или видеокадр, представляющий собой матрицу пикселей. Целью является обнаружение на изображении объектов, относящихся к определенному классу (в данном случае, человек), и определение их количества \(N\).
Методика обнаружения и подсчета:
1. Преобразование входных данных: Изображение \(X\) преобразуется с помощью функции `transform_image`, которая применяет к изображению серию предварительных операций, включая тензорное преобразование и нормализацию, результатом чего является \(X'\).
2. Применение модели Faster R-CNN: На преобразованное изображение \(X'\) в последовательности применяется модель Faster R-CNN, где \(F(X') = Y\), \(Y\) – набор предсказаний модели, включающий координаты ограничивающих рамок (bounding boxes) \(B\), вероятности принадлежности к классам \(P\), и метки классов \(C\).
3. Фильтрация и подсчет: Из набора предсказаний \(Y\), фильтруются объекты, у которых метка класса соответствует классу человек \(c=1\) и вероятность \(p > 0.8\), на основе чего оставшиеся объекты считаются найденными людьми. Количество таких объектов определяется как \(N\).
Математически, количество обнаруженных людей на изображении \(N\) вычисляется как:
\[N = \sum_{i=1}^{m} [c_i = 1 \: \wedge \: p_i > 0.8]\]
где \(m\) - общее количество объектов, обнаруженных на изображении, \(c_i\) - метка класса \(i\)-го объекта, \(p_i\) - вероятность того, что \(i\)-й объект принадлежит классу человек.
Эффективность и скорость обработки зависят от:
— качества исходных данных (разрешения изображений, освещенности),
— мощности обработки (использование GPU способствует значительному ускорению вычислений).
Для описания алгоритма решения задачи подсчета количества посетителей вокзала с использованием предобученной нейронной сети (НС) Fast R-CNN ResNet-50 FPN, приведем следующую структуру:
1. Загрузка видео: Пользователь загружает видеопоток через графический интерфейс, используя функцию load_video. Видеофайл передается в VideoProcessor для дальнейшей обработки.
2. Инициализация модели: Модель Fast R-CNN ResNet-50 FPN инициализируется с предобученными весами. Модель переводится в режим оценки (.eval()). Для обработки изображений используется GPU (если доступно).
3. Предобработка кадра видео: Каждый кадр преобразуется из формата BGR (используемый OpenCV) в RGB, затем в тензор PyTorch и нормализуется. Используется функция transform_image.
4. Обнаружение людей: Для каждого выбранного кадра (с интервалом, зависящим от FPS видео) модель детектирует людей. Выбираются только те обнаружения, у которых метка равна 1 (человек) и вероятность больше 0.8. Для каждого такого обнаружения рисуется прямоугольник вокруг области на изображении.
5. Сохранение и подсчет: Каждый кадр с обнаруженными людьми сохраняется в папку detected_people. Подсчитывается и выводится общее число обнаруженных людей на этом кадре.
6. Отчет: Информация о количестве обнаруженных людей и путь к соответствующему изображению выводятся в пользовательский интерфейс через сигналы update_label.
Обоснование выбора модели Fast R-CNN ResNet-50 FPN является оптимальным выбором для задачи обнаружения объектов за счет своей способности точно локализовать объекты разного размера на изображении и обладает высокой точностью в определении людей благодаря обширной обучающей выборке на датасете COCO.

### Инструменты разработки

**Стек:**
- Python
- Torch
- Pillow
- PyQt5
- OpenCV

## Разработка

##### 1) Клонировать репозиторий

    git clone https://github.com/mi-bogdan/Counting_objects_number_of_visitors.git

##### 2) Создать виртуальное окружение

    python -m venv venv

##### 3) Активировать виртуальное окружение

    venv/Scripts/activate

##### 4) Устанавливить зависимости:

    pip install -r requirements.txt

##### 5) Запустить интерфейс для работы:
    python main.py

Copyright (c) 2024-present, - Shnyra Bogdan
